
name: CI/CD Pipeline

on:
  push:
  # comment test
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  VERSION_MAJOR: 1
  VERSION_MINOR: 0

jobs:
  build:
    name: Build & Package
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-name: ${{ steps.package.outputs.artifact-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # full history for commit count

      - name: Show project structure
        run: |
          echo "=== Project Structure ==="
          ls -la
          echo ""
          echo "=== Asset Files ==="
          find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.json" \) | head -20

      - name: Generate semantic version
        id: version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="${{ env.VERSION_MAJOR }}.${{ env.VERSION_MINOR }}.${COMMIT_COUNT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Create deployment package
        id: package
        run: |
          VERSION=${{ steps.version.outputs.version }}
          PACKAGE_NAME="devops-final-project-${VERSION}"
          
          echo "=== Files to package ==="
          ls -lh *.html *.css *.js 2>/dev/null | grep -v node_modules || true
          
          zip -r "${PACKAGE_NAME}.zip" \
            index.html \
            style.css \
            demo.js \
            p5.js \
            p5.sound.min.js \
            README.md \
            -x "node_modules/*"
          
          ls -lh "${PACKAGE_NAME}.zip"
          echo "artifact-name=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT

  test:
    name: Automated Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install testing tools
        run: |
          npm install -g htmlhint stylelint eslint --save-dev
          echo "Testing tools installed"

      - name: HTML validation
        run: |
          echo "=== HTML Validation ==="
          if command -v htmlhint &> /dev/null; then
            htmlhint index.html || echo "Note: HTML hints found (non-blocking)"
          fi
          # Check for basic HTML structure
          if grep -q "<!DOCTYPE" index.html && grep -q "<html" index.html; then
            echo "✓ HTML structure valid"
          else
            echo "✗ HTML structure invalid"
            exit 1
          fi

      - name: CSS validation
        run: |
          echo "=== CSS Syntax Check ==="
          if [ -f style.css ]; then
            if grep -E "^\s*[a-z-]+\s*:" style.css > /dev/null; then
              echo "✓ CSS file has valid declarations"
            else
              echo "✗ CSS validation failed"
              exit 1
            fi
          fi

      - name: JavaScript syntax check
        run: |
          echo "=== JavaScript Syntax Check ==="
          for js_file in demo.js; do
            if [ -f "$js_file" ]; then
              node -c "$js_file" && echo "✓ $js_file syntax OK" || exit 1
            fi
          done

      - name: Smoke test - serve and validate
        run: |
          npm install -g http-server
          
          # Start server in background
          npx http-server -p 8080 &>/dev/null &
          SERVER_PID=$!
          sleep 2
          
          # Wait for server
          for i in {1..10}; do
            if curl -fsS http://localhost:8080 >/dev/null 2>&1; then
              echo "✓ Server is responding"
              break
            fi
            sleep 1
          done
          
          # Validate response
          content=$(curl -fsS http://localhost:8080/ || echo "")
          if echo "$content" | grep -qi "html\|DOCTYPE"; then
            echo "✓ HTML content served correctly"
          else
            echo "✗ Server did not return valid HTML"
            kill $SERVER_PID || true
            exit 1
          fi
          
          kill $SERVER_PID || true
          echo "✓ All smoke tests passed"

  package-and-release:
    name: Create Release Artifact
    runs-on: ubuntu-latest
    needs: [ build, test ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact metadata
        run: |
          echo "Version: ${{ needs.build.outputs.version }}"
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"

      - name: Create deployment package
        run: |
          VERSION=${{ needs.build.outputs.version }}
          PACKAGE_NAME="devops-final-project-${VERSION}"
          
          echo "=== Creating final package: ${PACKAGE_NAME}.zip ==="
          zip -r "${PACKAGE_NAME}.zip" \
            index.html \
            style.css \
            demo.js \
            p5.js \
            p5.sound.min.js \
            README.md \
            .github/workflows/ci-cd.yml \
            -x "node_modules/*" ".git/*"
          
          ls -lh "${PACKAGE_NAME}.zip"
          echo "ARTIFACT_PATH=${PACKAGE_NAME}.zip" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Upload artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: devops-final-project-${{ needs.build.outputs.version }}
          path: devops-final-project-${{ needs.build.outputs.version }}.zip
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: devops-final-project-${{ needs.build.outputs.version }}.zip
          tag_name: v${{ needs.build.outputs.version }}
          name: Release ${{ needs.build.outputs.version }}
          body: |
            ## Deployment Artifact v${{ needs.build.outputs.version }}
            
            **Build Details:**
            - Version: ${{ needs.build.outputs.version }}
            - Artifact: devops-final-project-${{ needs.build.outputs.version }}.zip
            - Build time: ${{ github.event.head_commit.timestamp }}
            
            **Tests Status:** ✅ All passed
            
            This artifact contains the complete website ready for deployment.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

